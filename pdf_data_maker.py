from google import genai
from google.genai import types
import json
import os

# 1. рдЖрдкрдХреА API Key
API_KEY = "AIzaSyCxCianaWuLDkJ4zk3l0jeOZoFDHmgHiV8"

# 2. рдирдпрд╛ Client рд╕реЗрдЯрдЕрдк (Google рдХреЗ рдирдП SDK рдХреЗ рдЕрдиреБрд╕рд╛рд░)
client = genai.Client(api_key=API_KEY)

print("==================================================")
print("ЁЯЪА Exam Chacha - Direct PDF to JSON Maker (New SDK) ЁЯЪА")
print("==================================================")

# 3. рдпреВрдЬрд╝рд░ рд╕реЗ PDF рдХрд╛ рдирд╛рдо рдкреВрдЫрдирд╛
pdf_filename = input("ЁЯУД рдЕрдкрдиреА PDF рдлрд╛рдЗрд▓ рдХрд╛ рдирд╛рдо рдбрд╛рд▓реЗрдВ (рдЬреИрд╕реЗ history.pdf): ")

if not os.path.exists(pdf_filename):
    print(f"тЭМ рдПрд░рд░: '{pdf_filename}' рдирд╛рдо рдХреА рдХреЛрдИ рдлрд╛рдЗрд▓ рдирд╣реАрдВ рдорд┐рд▓реА! рдзреНрдпрд╛рди рд░рдЦреЗрдВ рдХрд┐ PDF рдЙрд╕реА рдлреЛрд▓реНрдбрд░ рдореЗрдВ рд╣реЛред")
    exit()

# 4. PDF рдХреЛ AI рдХреЗ рдкрд╛рд╕ рдЕрдкрд▓реЛрдб рдХрд░рдирд╛
print(f"тП│ '{pdf_filename}' рдХреЛ AI рдХреЗ рдкрд╛рд╕ рднреЗрдЬрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ...")
try:
    # рдирдИ рдлрд╛рдЗрд▓ рдЕрдкрд▓реЛрдб рдХрдорд╛рдВрдб
    uploaded_file = client.files.upload(file=pdf_filename)
    print(f"тЬЕ рдлрд╛рдЗрд▓ рдЕрдкрд▓реЛрдб рд╣реЛ рдЧрдИ! (File URI: {uploaded_file.uri})")
except Exception as e:
    print(f"тЭМ рдлрд╛рдЗрд▓ рдЕрдкрд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рдПрд░рд░: {e}")
    exit()

# 5. AI рдХреЗ рд▓рд┐рдП рд╕реБрдкрд░-рдкреНрд░реЙрдореНрдкреНрдЯ
prompt = """
"You are an expert educational content creator. Your task is to extract data from the provided PDF and format it into a structured JSON for a mobile learning app. 

FOLLOW THESE STRICT RULES:

1. STRUCTURE: 
   - Each JSON must have 'subjectId', 'subjectTitle', and a 'topics' array.
   - Inside 'topics', divide the content into 'Types' or 'Concepts' (e.g., TYPE-1, TYPE-2).

2. SLIDES (Educational Content):
   - Don't put everything in one slide. 
   - Slide 1: Explain the Concept/Formula clearly in Hindi/English mixed (Hinglish).
   - Slide 2: Show an example or a step-by-step derivation.
   - Use Markdown for bold text (e.g., **Formula**) and LaTeX for math (e.g., $x^2 + \frac{1}{x^2}$).
   - Include a placeholder for a diagram if relevant: 

[Image of X]
.

3. QUESTIONS (Practice):
   - For every 'Topic/Type', generate at least 4-5 relevant Multiple Choice Questions.
   - Each question must have: 'questionText', 'options' (array of 4), and 'correctAnswer'.
   - Ensure the options are plausible and the math is accurate.

4. LANGUAGE:
   - Use Hindi (Devanagari) for prose and descriptions.
   - Use English/LaTeX for Mathematical terms and equations.

5. FORMAT:
   - Output ONLY the raw JSON. No conversational text.
   - Follow the exact schema provided in the user's 'perfect example'."

REQUIRED JSON OUTPUT STRUCTURE EXAMPLE:
{
  "subjectId": "ba_constitution_v1",
  "subjectTitle": "рднрд╛рд░рдд рдХрд╛ рд╕рдВрд╡рд┐рдзрд╛рди - Class 1 (рднрд╛рд░рдд рдХрд╛ рд╕рдВрд╡реИрдзрд╛рдирд┐рдХ рд╡рд┐рдХрд╛рд╕)",
  "topics": [
    {
      "title": "рднрд╛рд░рдд рдХрд╛ рд╕рдВрд╡реИрдзрд╛рдирд┐рдХ рд╡рд┐рдХрд╛рд╕: рдХрдВрдкрдиреА рдПрд╡рдВ рдХреНрд░рд╛рдЙрди рдХрд╛ рд╢рд╛рд╕рди (Class-1)",
      "slides": [
        "тАв **рд╡рд┐рдХрд╛рд╕ рдХреЗ рдЪрд░рдг:** рднрд╛рд░рддреАрдп рд╕рдВрд╡рд┐рдзрд╛рди рдХрд╛ рдРрддрд┐рд╣рд╛рд╕рд┐рдХ рд╡рд┐рдХрд╛рд╕ рджреЛ рдореБрдЦреНрдп рднрд╛рдЧреЛрдВ рдореЗрдВ рд╡рд┐рднрд╛рдЬрд┐рдд рд╣реИ:\n1. **рдХрдВрдкрдиреА рдХрд╛ рд╢рд╛рд╕рди (1773-1858):** рдЗрд╕рдореЗрдВ рд░реЗрдЧреБрд▓реЗрдЯрд┐рдВрдЧ рдПрдХреНрдЯ рдФрд░ рдЪрд╛рд░реНрдЯрд░ рдПрдХреНрдЯ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред\n2. **рдХреНрд░рд╛рдЙрди рдХрд╛ рд╢рд╛рд╕рди (1858-1947):** рдЗрд╕рдореЗрдВ рднрд╛рд░рдд рд╢рд╛рд╕рди рдЕрдзрд┐рдирд┐рдпрдо рдФрд░ рдкрд░рд┐рд╖рдж рдЕрдзрд┐рдирд┐рдпрдо рдЖрддреЗ рд╣реИрдВред",
        "тАв **рд░реЗрдЧреБрд▓реЗрдЯрд┐рдВрдЧ рдПрдХреНрдЯ 1773:** рдЗрд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рдмрдВрдЧрд╛рд▓ рдХреЗ рдЧрд╡рд░реНрдирд░ рдХреЛ 'рдЧрд╡рд░реНрдирд░ рдЬрдирд░рд▓' рдмрдирд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ (рд╡рд╛рд░реЗрди рд╣реЗрд╕реНрдЯрд┐рдВрдЧреНрд╕ рдкрд╣рд▓реЗ рдЧрд╡рд░реНрдирд░ рдЬрдирд░рд▓ рдмрдиреЗ)ред рдЗрд╕рдХреЗ рддрд╣рдд 1774 рдореЗрдВ рдХрд▓рдХрддреНрддрд╛ рдореЗрдВ рд╕реБрдкреНрд░реАрдо рдХреЛрд░реНрдЯ рдХреА рд╕реНрдерд╛рдкрдирд╛ рд╣реБрдИ, рдЬрд┐рд╕рдХреЗ рдкреНрд░рдердо рдореБрдЦреНрдп рдиреНрдпрд╛рдпрд╛рдзреАрд╢ рд╕рд░ рдПрд▓рд┐рдЬрд╛ рдЗрдореНрдкреЗ рдереЗред",
        "тАв **рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЪрд╛рд░реНрдЯрд░ рдПрдХреНрдЯ:** \n1. **1813 рдХрд╛ рдЪрд╛рд░реНрдЯрд░:** рд╢рд┐рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рд╡рд░реНрд╖ 1 рд▓рд╛рдЦ рд░реБрдкрдпреЗ рдХрд╛ рдкреНрд░рд╛рд╡рдзрд╛рди рдФрд░ рдХрдВрдкрдиреА рдХрд╛ рд╡реНрдпрд╛рдкрд╛рд░рд┐рдХ рдПрдХрд╛рдзрд┐рдХрд╛рд░ (рдЪрд╛рдп-рдЪреАрди рдЫреЛреЬрдХрд░) рд╕рдорд╛рдкреНрдд рд╣реБрдЖред\n2. **1833 рдХрд╛ рдЪрд╛рд░реНрдЯрд░:** рдмрдВрдЧрд╛рд▓ рдХреЗ рдЧрд╡рд░реНрдирд░ рдЬрдирд░рд▓ рдХреЛ 'рднрд╛рд░рдд рдХрд╛ рдЧрд╡рд░реНрдирд░ рдЬрдирд░рд▓' (рд▓реЙрд░реНрдб рд╡рд┐рд▓рд┐рдпрдо рдмреИрдгреНрдЯрд┐рдВрдХ) рдмрдирд╛рдпрд╛ рдЧрдпрд╛ред\n3. **1853 рдХрд╛ рдЪрд╛рд░реНрдЯрд░:** рд╡рд┐рдзрд╛рдпреА рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдХрд╛рд░реНрдпреЛрдВ рд╕реЗ рдЕрд▓рдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдФрд░ рд╕рд┐рд╡рд┐рд▓ рд╕реЗрд╡рд╛ рдореЗрдВ рднрд╛рд░рддреАрдпреЛрдВ рдХреА рднрд╛рдЧреАрджрд╛рд░реА рд╢реБрд░реВ рд╣реБрдИред",
        "тАв **рдмреНрд░рд┐рдЯрд┐рд╢ рдХреНрд░рд╛рдЙрди рдХреЗ рдЕрдзрд┐рдирд┐рдпрдо:** \n1. **1858 рдХрд╛ рдПрдХреНрдЯ:** рд╢рд╛рд╕рди рд╕реАрдзреЗ рдмреНрд░рд┐рдЯрд┐рд╢ рддрд╛рдЬ рдХреЗ рдЕрдзреАрди рдЖрдпрд╛ рдФрд░ рд╡рд╛рдпрд╕рд░рд╛рдп (рд▓реЙрд░реНрдб рдХреИрдирд┐рдВрдЧ) рдкрдж рдмрдирд╛ред\n2. **1909 рдХрд╛ рдПрдХреНрдЯ (рдорд╛рд░реНрд▓реЗ-рдорд┐рдгреНрдЯреЛрдВ):** рдореБрд╕реНрд▓рд┐рдореЛрдВ рдХреЗ рд▓рд┐рдП рдкреГрдердХ рдирд┐рд░реНрд╡рд╛рдЪрдХ рдордВрдбрд▓ рдХрд╛ рдкреНрд░рд╛рд╡рдзрд╛рдиред\n3. **1935 рдХрд╛ рдПрдХреНрдЯ:** рдЕрдЦрд┐рд▓ рднрд╛рд░рддреАрдп рд╕рдВрдШ, рд╕рдВрдШреАрдп рдиреНрдпрд╛рдпрд╛рд▓рдп рдФрд░ рднрд╛рд░рддреАрдп рд░рд┐рдЬрд░реНрд╡ рдмреИрдВрдХ рдХреА рд╕реНрдерд╛рдкрдирд╛ рдХрд╛ рдкреНрд░рд╛рд╡рдзрд╛рдиуАВ"
      ],
      "questions": [
        { "questionText": "рдХрд▓рдХрддреНрддрд╛ рдореЗрдВ рд╕реБрдкреНрд░реАрдо рдХреЛрд░реНрдЯ рдХреА рд╕реНрдерд╛рдкрдирд╛ рдХрд┐рд╕ рд╡рд░реНрд╖ рд╣реБрдИ рдереА?", "options": ["1773", "1774", "1784", "1813"], "correctAnswer": "1774" },
        { "questionText": "рдмрдВрдЧрд╛рд▓ рдХреЗ рдкреНрд░рдердо рдЧрд╡рд░реНрдирд░ рдЬрдирд░рд▓ рдХреМрди рдереЗ?", "options": ["рд▓реЙрд░реНрдб рдХреИрдирд┐рдВрдЧ", "рд╡рд╛рд░реЗрди рд╣реЗрд╕реНрдЯрд┐рдВрдЧреНрд╕", "рд▓реЙрд░реНрдб рдХрд░реНрдЬрди", "рд╡рд┐рд▓рд┐рдпрдо рдмреИрдгреНрдЯрд┐рдВрдХ"], "correctAnswer": "рд╡рд╛рд░реЗрди рд╣реЗрд╕реНрдЯрд┐рдВрдЧреНрд╕" },
"""

print(f"ЁЯза AI рдЖрдкрдХреА PDF рдкрдврд╝ рд░рд╣рд╛ рд╣реИ рдФрд░ рдиреЛрдЯреНрд╕ рдмрдирд╛ рд░рд╣рд╛ рд╣реИ... (рдмрдбрд╝реА PDF рдореЗрдВ 1-2 рдорд┐рдирдЯ рд▓рдЧ рд╕рдХрддреЗ рд╣реИрдВ)")

try:
    # 6. рдирдпрд╛ Generate Content рдХрдорд╛рдВрдб (рд╕рдмрд╕реЗ рдирдП рдореЙрдбрд▓ рдХреЗ рд╕рд╛рде)
    response = client.models.generate_content(
        model='gemini-2.5-flash', # рдирдпрд╛ рдФрд░ рд╕рдмрд╕реЗ рддреЗрдЬрд╝ рдореЙрдбрд▓
        contents=[uploaded_file, prompt],
        config=types.GenerateContentConfig(
            response_mime_type="application/json",
        )
    )
    
    # 7. JSON рдХреЛ рд╕рдордЭрдирд╛ рдФрд░ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдлрд╛рдЗрд▓реЛрдВ рдореЗрдВ рддреЛрдбрд╝рдирд╛
    data = json.loads(response.text)
    classes_list = data.get("classes", [])
    
    if not classes_list:
        print("тЭМ AI рдиреЗ рдХреЛрдИ рдбреЗрдЯрд╛ рдирд╣реАрдВ рджрд┐рдпрд╛ред")
        exit()

    print(f"\nтЬЕ AI рдиреЗ PDF рдХреЛ {len(classes_list)} рднрд╛рдЧреЛрдВ (Classes) рдореЗрдВ рдмрд╛рдБрдЯ рджрд┐рдпрд╛ рд╣реИ!")
    
    generated_files = []
    base_name = pdf_filename.replace('.pdf', '') 
    
    for i, class_data in enumerate(classes_list):
        filename = f"{base_name}_part_{i+1}.json"
        
        with open(filename, "w", encoding="utf-8") as f:
            json.dump(class_data, f, indent=2, ensure_ascii=False)
            
        generated_files.append({"title": class_data.get("subjectTitle", f"Class Part {i+1}"), "file": filename})
        print(f"   ЁЯТ╛ рд╕реЗрд╡ рд╣реЛ рдЧрдИ: {filename} ({len(class_data.get('topics', []))} Topics)")

    print("\n==================================================")
    print("ЁЯЫая╕П  Index Update Code:")
    for item in generated_files:
        print(f"""    {{
      "title": "{item['title']}",
      "type": "class",
      "url": "https://exam-chacha.pages.dev/{item['file']}"
    }},""")
    print("==================================================")

    # 8. рд╕рд░реНрд╡рд░ рд╕реЗ рдлрд╛рдЗрд▓ рдбрд┐рд▓реАрдЯ рдХрд░рдирд╛
    client.files.delete(name=uploaded_file.name)

except Exception as e:
    print(f"тЭМ рдХреБрдЫ рдЧрдбрд╝рдмрдбрд╝ рд╣реЛ рдЧрдИ: {e}")